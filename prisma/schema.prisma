generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Note: SQLite doesn't support enums, so we use String with validation in the application layer
// Valid values for role: STUDENT, EXPERT, ADMIN
// Valid values for senderRole: STUDENT, AI, EXPERT, SYSTEM
// Valid values for ticketStatus: REQUESTED, ASSIGNED, IN_REVIEW, VERIFIED, CLOSED
// Valid values for conversationStatus: ACTIVE, CLOSED

model User {
  id        String   @id @default(cuid())
  name      String? 
  email     String   @unique
  role      String   @default("STUDENT")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  conversations    Conversation[]    @relation("StudentConversations")
  ticketsAsStudent EmergencyTicket[] @relation("StudentTickets")
  ticketsAsExpert  EmergencyTicket[] @relation("ExpertTickets")
  notes            Note[]
  messages         Message[]
}

model Conversation {
  id        String   @id @default(cuid())
  studentId String
  status    String @default("ACTIVE")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student  User       @relation("StudentConversations", fields: [studentId], references:  [id], onDelete:  Cascade)
  messages Message[]
  ticket   EmergencyTicket? 

  @@index([studentId, updatedAt])
}

model Message {
  id             String     @id @default(cuid())
  conversationId String
  senderRole     String
  senderId       String? 
  text           String
  attachmentUrl  String? 

  createdAt      DateTime   @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User?        @relation(fields: [senderId], references:  [id], onDelete: SetNull)

  @@index([conversationId, createdAt])
}

model EmergencyTicket {
  id             String       @id @default(cuid())
  conversationId String       @unique
  studentId      String
  expertId       String? 

  status         String @default("REQUESTED")

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  verifiedAt     DateTime? 

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  student      User        @relation("StudentTickets", fields: [studentId], references: [id], onDelete: Cascade)
  expert       User?       @relation("ExpertTickets", fields: [expertId], references:  [id], onDelete: SetNull)

  @@index([studentId, updatedAt])
  @@index([expertId, status, updatedAt])
}

model Note {
  id             String   @id @default(cuid())
  studentId      String
  title          String? 
  content        String
  conversationId String? 
  messageId      String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId, updatedAt])
  @@index([conversationId])
}

model Resource {
  id          String   @id @default(cuid())
  title       String
  description String? 
  url         String? 

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
